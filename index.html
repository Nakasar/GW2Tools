<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="theme-color" content="#000000">
  <meta name="description" content="">
  <meta name="author" content="Kevin 'Nakasar' Thizy">

  <title>Cartographe - Outils RP</title>

  <link rel="icon" href="/src/favicon.ico" />

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link rel="stylesheet" href="/src/open-iconic/font/css/open-iconic-bootstrap.css">
  <link rel="stylesheet" href="components/style_global.css">
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <header>
    <div id="navigation">
    </div>
  </header>

  <div class="container loader" id="loader">
    <!-- By Sam Herbert (@sherb), for everyone. More @ http://goo.gl/7AJzbL -->
    <svg width="88" height="88" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg" stroke="#fff">
        <g fill="none" fill-rule="evenodd" stroke-width="2">
            <circle cx="22" cy="22" r="1">
                <animate attributeName="r"
                    begin="0s" dur="1.8s"
                    values="1; 20"
                    calcMode="spline"
                    keyTimes="0; 1"
                    keySplines="0.165, 0.84, 0.44, 1"
                    repeatCount="indefinite" />
                <animate attributeName="stroke-opacity"
                    begin="0s" dur="1.8s"
                    values="1; 0"
                    calcMode="spline"
                    keyTimes="0; 1"
                    keySplines="0.3, 0.61, 0.355, 1"
                    repeatCount="indefinite" />
            </circle>
            <circle cx="22" cy="22" r="1">
                <animate attributeName="r"
                    begin="-0.9s" dur="1.8s"
                    values="1; 20"
                    calcMode="spline"
                    keyTimes="0; 1"
                    keySplines="0.165, 0.84, 0.44, 1"
                    repeatCount="indefinite" />
                <animate attributeName="stroke-opacity"
                    begin="-0.9s" dur="1.8s"
                    values="1; 0"
                    calcMode="spline"
                    keyTimes="0; 1"
                    keySplines="0.3, 0.61, 0.355, 1"
                    repeatCount="indefinite" />
            </circle>
        </g>
    </svg>
  </div>

  <div id="page" class="container" style="display: none;">
    <div class="container">
      <div class="alert alert-danger alert-dismissible" role="alert" id="main-alert">
        <div id="text">Nous avons détecté une erreur inconnue. Le problème vient probablement de notre côté des Brumes :/</div>
        <button type="button" class="close" data-dismiss="alert" aria-label="Fermer">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-6" id="next-events">
          <h4>Prochains évènements</h4>
          <div class="list-group" id="incoming-event-list"></div>
        </div>
        <div class="col-md-6" id="last-rumours">
          <h4>Dernières rumeurs</h4>
          <div class="list-group" id="latest-rumours-list"></div>
        </div>
      </div>
    </div>

    <!-- Event detail Modal -->
    <div class="modal fade" id="event-details-modal" tabindex="-1" role="dialog" aria-labelledby="event-details-modal-title" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="event-details-modal-title">Modal title</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container">
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-date">Date :</label>
                  <p id="event-details-modal-date"></p>
                </div>
                <div class="col-sm">
                  <label for="event-details-modal-difficulty">Difficulté :</label>
                  <p id="event-details-modal-difficulty"></p>
                </div>
              </div>
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-contact">Contact :</label>
                  <p id="event-details-modal-contact"></p>
                </div>
                <div class="col-sm">
                  <label for="event-details-modal-contact">Participants :</label>
                  <br/>
                  <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-outline text-success action-btn" title="Oui !" id="participants-yes-button"><span id="participants-yes">0</span> <span class="oi oi-check"></span></button>
                    <button type="button" class="btn btn-outline text-warning action-btn" title="Peut-être ?" id="participants-maybe-button"><span id="participants-maybe">0</span> <span class="oi oi-question-mark"></span></button>
                    <button type="button" class="btn btn-outline text-danger action-btn" title="Non." id="participants-no-button"><span id="participants-no">0</span> <span class="oi oi-x"></span></button>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-description">Description :</label>
                  <p id="event-details-modal-description"></p>
                </div>
              </div>
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-site">Site :</label>
                  <p id="event-details-modal-site"></p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a id="tomap-btn" class="btn btn-primary" href="/cartographe?id=" role="button">Voir sur la carte</a>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  </div><!-- /.container -->

  <!-- Rumour Modal -->
  <div class="modal fade" id="rumour-details-modal" tabindex="-1" role="dialog" aria-labelledby="event-details-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rumour-details-modal-title">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col-sm">
                <label for="rumour-details-modal-contact">Contact :</label>
                <p id="rumour-details-modal-contact"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-sm">
                <label for="rumour-details-modal-description">Rumeur :</label>
                <p id="rumour-details-modal-description"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-sm">
                <label for="rumour-details-modal-site">Site :</label>
                <p id="rumour-details-modal-site"></p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <a id="tomap-btn" class="btn btn-primary" href="/cartographe?id=" role="button">Voir sur la carte</a>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
</div><!-- /.container -->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

  <script src="/components/base.js"></script>
  <script src="/components/connect.js"></script>

  <script>
  $('#main-alert').hide();
  $('#navigation').load("/components/header.html", function() {
    establishConnectionCallback(function(success) {
      $("#loader").hide()
      $("#page").show()
    });
  });

  function displayAPIAlert() {
    $("#loader").hide()
    $("#page").show()
    $('#main-alert #text').text("Le GOLEM M4554G3R n'a pas pu contacter le serveur dans les Brumes, le problème vient certainement de notre côté.");
    $('#main-alert').show();
  }
  </script>

  <script>
    var difficulty_table = new Map();
    difficulty_table.set("peaceful", "Promenade");
    difficulty_table.set("easy", "Facile");
    difficulty_table.set("normal", "Normal");
    difficulty_table.set("difficult", "Difficile");
    difficulty_table.set("hardcore", "Epique");

    var translate_types = new Map();
    translate_types.set("tavern", "Taverne");
    translate_types.set("trading", "Commerce");
    translate_types.set("exploration", "Exploration");
    translate_types.set("mercenary", "Mercenariat");
    translate_types.set("research", "Recherche");
    translate_types.set("nobility", "Noblesse");
    //
    translate_types.set("battle", "Bataille");
    translate_types.set("camp", "Campement");
    translate_types.set("communitary", "Communautaire");
    translate_types.set("damages", "Dégâts");
    translate_types.set("danger", "Zone dangereuse");
    //
    translate_types.set("other", "Autre");

    // retrieves 5 next events and displays them in a list.
    $.ajax({
      method: "GET",
      url: `${api_url}/events?next=5`,
      dataType: 'json',
      success: function(json) {
        if (json.success) {
          var events = json.events;
          $('#incoming-event-list').html("");
          for (var event_index in events) {
            addEventToList('#incoming-event-list', events[event_index]);
          }
        }
      }
    });

    // retrieves 5 latest rumours and displays them in a list.
    $.ajax({
      method: "GET",
      url: `${api_url}/rumours?latest=5`,
      dataType: 'json',
      success: function(json) {
        if (json.success) {
          var rumours = json.rumours;
          $('#latest-rumours-list').html("");
          for (var rumour_index in rumours) {
            addRumourToList('#latest-rumours-list', rumours[rumour_index]);
          }
        }
      }
    });

    function formatText(text) {
      var formatted = "";

      formatted = text.replace(/\[color=(.+)\](.+)\[\/color\]/g, '<span style="color: $1;">$2</span>');
      formatted = formatted.replace(/\[b\](.+)\[\/b\]/g, '<strong>$1</strong>');
      formatted = formatted.replace(/\*\*(.+)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/\[i\](.+)\[\/i\]/g, '<em>$1</em>');
      formatted = formatted.replace(/\*(.+)\*/g, '<em>$1</em>');
      formatted = formatted.replace(/\[u\](.+)\[\/u\]/g, '<u>$1</u>')
      formatted = formatted.replace(/_(.+)_/g, '<u>$1</u>')
      formatted = formatted.replace(/\\n/g, '<br>')

      return formatted;
    }

    var displayedLocation = {}
    function showEventModal(eventId) {
      $.ajax({
        method: "GET",
        url: `${api_url}/events/` + eventId,
        dataType: 'json',
        success: function(json) {
          if (json.success) {
            var event = json.event;
            displayedLocation = event
            $('#event-details-modal-title').text(event.name);
            $('#event-details-modal-description').html(formatText(event.description));
            var date = new Date(event.end_date);
            if (date) {
              var dateString = date.toLocaleDateString().substr(0, 10);
              if (date.getHours() > 0) {
                dateString += " - " + date.toLocaleTimeString().substr(0, 5);
              }
              $('#event-details-modal-date').text(dateString);
            }
            $('#event-details-modal-difficulty').text(difficulty_table.get(event.difficulty));
            $('#event-details-modal-contact').text(event.contact);
            $('#event-details-modal-site').html("<a href='" + event.site + "' target='_blank'>" + event.site + "</a>");
            $('#event-details-modal #tomap-btn').attr('href', '/cartographe?id=' + event._id);

            var pretty = { yes: [], maybe: [], no: [] }
            var thisUserParticipation = "none"
            for (var participant of event.participants) {
              if (thisUser && thisUser.signedIn && participant.user === thisUser.id) {
                thisUserParticipation = participant.status
              }
              switch (participant.status) {
                case "yes":
                  pretty.yes.push({ name: participant.name, id: participant.user, status: "yes" })
                  break;
                case "maybe":
                  pretty.maybe.push({ name: participant.name, id: participant.user, status: "maybe" })
                  break;
                default:
                  pretty.no.push({ name: participant.name, id: participant.user, status: "no" })
                  break;
              }
            }
            $('#participants-yes').text(pretty.yes.length);
            $('#participants-maybe').text(pretty.maybe.length);
            $('#participants-no').text(pretty.no.length);
            $('#participants-yes-button').removeClass()
            $('#participants-maybe-button').removeClass()
            $('#participants-no-button').removeClass()
            switch (thisUserParticipation) {
              case "none":
                $('#participants-yes-button').addClass("btn btn-outline text-success action-btn")
                $('#participants-maybe-button').addClass("btn btn-outline text-warning action-btn")
                $('#participants-no-button').addClass("btn btn-outline text-danger action-btn")
                break
              case "yes":
                $('#participants-yes-button').addClass("btn btn-success action-btn")
                $('#participants-maybe-button').addClass("btn btn-outline text-warning action-btn")
                $('#participants-no-button').addClass("btn btn-outline text-danger action-btn")
                break
              case "maybe":
                $('#participants-yes-button').addClass("btn btn-outline text-success action-btn")
                $('#participants-maybe-button').addClass("btn btn-warning action-btn")
                $('#participants-no-button').addClass("btn btn-outline text-danger action-btn")
                break
              default:
                $('#participants-yes-button').addClass("btn btn-outline text-success action-btn")
                $('#participants-maybe-button').addClass("btn btn-outline text-warning action-btn")
                $('#participants-no-button').addClass("btn btn-danger action-btn")
                break
            }

            $('#event-details-modal').modal('show');
          }
        }
      });
    }

    function addEventToList(idList, event) {
      var currentHtml = $(idList).html();
      var date = new Date(event.end_date);
      var dateString = date.toLocaleDateString().substr(0, 10);
      if (date.getHours() > 0) {
        dateString += " - " + date.toLocaleTimeString().substr(0, 5);
      }
      var thisEventHtml = '<div href="#" class="list-group-item flex-column align-items-start"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">' + event.name + '</h5><small>' + dateString + '</small></div><p class="mb-1" style="white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; max-height: 100px;">' + formatText(event.description) + '</p><a href="#" onclick="showEventModal(\'' +  event._id + '\')"><small>En lire plus...</small></a> ou <a href="/cartographe?id=' + event._id + '"><small>Voir sur la carte.</small></a></div>';
      currentHtml += thisEventHtml;
      $(idList).html(currentHtml);
    }

    $("#participants-yes-button").click(function() {
      actionParticipate(displayedLocation._id, "yes")
    })
    $("#participants-maybe-button").click(function() {
      actionParticipate(displayedLocation._id, "maybe")
    })
    $("#participants-no-button").click(function() {
      actionParticipate(displayedLocation._id, "no")
    })

    function actionParticipate(eventId, participation) {
      if (thisUser && thisUser.signedIn) {
        $.ajax({
          method: "POST",
          url: `${api_url}/events/${eventId}/participate`,
          data: { token: thisUser.token, status: participation },
          dataType: "json",
          success: function(json) {
            console.log(json)
            if (json.success) {
              if (displayedLocation._id === json.event._id) {
                // Update sidebar participants
                var pretty = { yes: [], maybe: [], no: [] }
                var thisUserParticipation = "none"
                for (var participant of json.event.participants) {
                  if (thisUser && thisUser.signedIn && participant.user === thisUser.id) {
                    thisUserParticipation = participant.status
                  }
                  switch (participant.status) {
                    case "yes":
                      pretty.yes.push({ name: participant.name, id: participant.user, status: "yes" })
                      break;
                    case "maybe":
                      pretty.maybe.push({ name: participant.name, id: participant.user, status: "maybe" })
                      break;
                    default:
                      pretty.no.push({ name: participant.name, id: participant.user, status: "no" })
                      break;
                  }
                }
                $('#participants-yes').text(pretty.yes.length);
                $('#participants-maybe').text(pretty.maybe.length);
                $('#participants-no').text(pretty.no.length);
                $('#participants-yes-button').removeClass()
                $('#participants-maybe-button').removeClass()
                $('#participants-no-button').removeClass()
                switch (thisUserParticipation) {
                  case "none":
                    $('#participants-yes-button').addClass("btn btn-outline text-success action-btn")
                    $('#participants-maybe-button').addClass("btn btn-outline text-warning action-btn")
                    $('#participants-no-button').addClass("btn btn-outline text-danger action-btn")
                    break
                  case "yes":
                    $('#participants-yes-button').addClass("btn btn-success action-btn")
                    $('#participants-maybe-button').addClass("btn btn-outline text-warning action-btn")
                    $('#participants-no-button').addClass("btn btn-outline text-danger action-btn")
                    break
                  case "maybe":
                    $('#participants-yes-button').addClass("btn btn-outline text-success action-btn")
                    $('#participants-maybe-button').addClass("btn btn-warning action-btn")
                    $('#participants-no-button').addClass("btn btn-outline text-danger action-btn")
                    break
                  default:
                    $('#participants-yes-button').addClass("btn btn-outline text-success action-btn")
                    $('#participants-maybe-button').addClass("btn btn-outline text-warning action-btn")
                    $('#participants-no-button').addClass("btn btn-danger action-btn")
                    break
                }
              }
            }
          }
        })
      } else {
        showLoginModal()
      }
    }

    function showRumourModal(rumourId) {
      $.ajax({
        method: "GET",
        url: `${api_url}/rumours/` + rumourId,
        dataType: 'json',
        success: function(json) {
          if (json.success) {
            var rumour = json.rumour;
            $('#rumour-details-modal-title').text(rumour.name);
            $('#rumour-details-modal-description').html(formatText(rumour.text));

            $('#rumour-details-modal-contact').text(rumour.contact);
            $('#rumour-details-modal-site').html("<a href='" + rumour.site + "' target='_blank'>" + rumour.site + "</a>");
            $('#rumour-details-modal #tomap-btn').attr('href', '/cartographe?id=' + rumour._id);
            $('#rumour-details-modal').modal('show');
          }
        }
      });
    }

    function addRumourToList(idList, rumour) {
      var currentHtml = $(idList).html();
      var thisRumourHtml = '<div href="#" class="list-group-item flex-column align-items-start"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">' + rumour.name + '</h5></div><p class="mb-1" style="white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; max-height: 100px;">' + formatText(rumour.text) + '</p><a href="#" onclick="showRumourModal(\'' +  rumour._id + '\')"><small>En lire plus...</small></a> ou <a href="/cartographe?id=' + rumour._id + '"><small>Voir sur la carte.</small></a></div>';
      currentHtml += thisRumourHtml;
      $(idList).html(currentHtml);
    }
  </script>

</body>
</html>
