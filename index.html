<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="theme-color" content="#000000">
  <meta name="description" content="">
  <meta name="author" content="Kevin 'Nakasar' Thizy">

  <title>Cartographe - Outils RP</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <link rel="stylesheet" href="components/style_global.css">
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <header>
    <div id="navigation">
    </div>
  </header>

  <div class="container">
    <div class="container">
      <div class="alert alert-danger alert-dismissible" role="alert" id="main-alert">
        <div id="text">Nous avons détecté une erreur inconnue. Le problème vient probablement de notre côté des Brumes :/</div>
        <button type="button" class="close" data-dismiss="alert" aria-label="Fermer">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div class="container">
      <div class="alert alert-warning" role="alert">
        <h4 class="alert-heading">Documentation API</h4>
        <p>L'accès à l'API commence à <a href="/api">/api</a>.
          <br/>
          La documentation est accessible via l'onglet "Documentation".
        </p>
      </div>
      <div class="container">
        <h4>Prochains évènements</h4>
        <div class="list-group" id="incoming-event-list"></div>
      </div>
      <div class="container">
        <h4>Dernières rumeurs</h4>
        <div class="list-group" id="latest-rumours-list"></div>
      </div>
    </div>

    <!-- Event detail Modal -->
    <div class="modal fade" id="event-details-modal" tabindex="-1" role="dialog" aria-labelledby="event-details-modal-title" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="event-details-modal-title">Modal title</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container">
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-date">Date :</label>
                  <p id="event-details-modal-date"></p>
                </div>
                <div class="col-sm">
                  <label for="event-details-modal-difficulty">Difficulté :</label>
                  <p id="event-details-modal-difficulty"></p>
                </div>
              </div>
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-contact">Contact :</label>
                  <p id="event-details-modal-contact"></p>
                </div>
              </div>
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-description">Description :</label>
                  <p id="event-details-modal-description"></p>
                </div>
              </div>
              <div class="row">
                <div class="col-sm">
                  <label for="event-details-modal-site">Site :</label>
                  <p id="event-details-modal-site"></p>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <a id="tomap-btn" class="btn btn-primary" href="/cartographe?id=" role="button">Voir sur la carte</a>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  </div><!-- /.container -->

  <!-- Rumour Modal -->
  <div class="modal fade" id="rumour-details-modal" tabindex="-1" role="dialog" aria-labelledby="event-details-modal-title" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="rumour-details-modal-title">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="container">
            <div class="row">
              <div class="col-sm">
                <label for="rumour-details-modal-contact">Contact :</label>
                <p id="rumour-details-modal-contact"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-sm">
                <label for="rumour-details-modal-description">Rumeur :</label>
                <p id="rumour-details-modal-description"></p>
              </div>
            </div>
            <div class="row">
              <div class="col-sm">
                <label for="rumour-details-modal-site">Site :</label>
                <p id="rumour-details-modal-site"></p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <a id="tomap-btn" class="btn btn-primary" href="/cartographe?id=" role="button">Voir sur la carte</a>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>
</div><!-- /.container -->

  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

  <script src="/components/base.js"></script>
  <script src="/components/connect.js"></script>

  <script>
  $('#main-alert').hide();
  $('#navigation').load("/components/header.html", function() {
    establishConnectionCallback(function(success) {});
  });

  function displayAPIAlert() {
    $('#main-alert #text').text("Le GOLEM M4554G3R n'a pas pu contacter le serveur dans les Brumes, le problème vient certainement de notre côté.");
    $('#main-alert').show();
  }
  </script>

  <script>
    var difficulty_table = new Map();
    difficulty_table.set("peaceful", "Promenade");
    difficulty_table.set("easy", "Facile");
    difficulty_table.set("normal", "Normal");
    difficulty_table.set("difficult", "Difficile");
    difficulty_table.set("hardcore", "Epique");

    var translate_types = new Map();
    translate_types.set("tavern", "Taverne");
    translate_types.set("trading", "Commerce");
    translate_types.set("exploration", "Exploration");
    translate_types.set("mercenary", "Mercenariat");
    translate_types.set("research", "Recherche");
    translate_types.set("nobility", "Noblesse");
    //
    translate_types.set("battle", "Bataille");
    translate_types.set("camp", "Campement");
    translate_types.set("communitary", "Communautaire");
    translate_types.set("damages", "Dégâts");
    translate_types.set("danger", "Zone dangereuse");
    //
    translate_types.set("other", "Autre");

    // retrieves 5 next events and displays them in a list.
    $.ajax({
      method: "GET",
      url: 'https://gw2rp-tools.ovh/api/events?next=5',
      dataType: 'json',
      success: function(json) {
        if (json.success) {
          var events = json.events;
          $('#incoming-event-list').html("");
          for (var event_index in events) {
            addEventToList('#incoming-event-list', events[event_index]);
          }
        }
      }
    });

    // retrieves 5 latest rumours and displays them in a list.
    $.ajax({
      method: "GET",
      url: 'https://gw2rp-tools.ovh/api/rumours?latest=5',
      dataType: 'json',
      success: function(json) {
        if (json.success) {
          var rumours = json.rumours;
          $('#latest-rumours-list').html("");
          for (var rumour_index in rumours) {
            addRumourToList('#latest-rumours-list', rumours[rumour_index]);
          }
        }
      }
    });

    function formatText(text) {
      var formatted = "";

      formatted = text.replace(/\[color=(.+)\](.+)\[\/color\]/g, '<span style="color: $1;">$2</span>');
      formatted = formatted.replace(/\[b\](.+)\[\/b\]/g, '<strong>$1</strong>');
      formatted = formatted.replace(/\*\*(.+)\*\*/g, '<strong>$1</strong>');
      formatted = formatted.replace(/\[i\](.+)\[\/i\]/g, '<em>$1</em>');
      formatted = formatted.replace(/\*(.+)\*/g, '<em>$1</em>');
      formatted = formatted.replace(/\[u\](.+)\[\/u\]/g, '<u>$1</u>')
      formatted = formatted.replace(/_(.+)_/g, '<u>$1</u>')
      formatted = formatted.replace(/\\n/g, '<br>')

      return formatted;
    }

    function showEventModal(eventId) {
      $.ajax({
        method: "GET",
        url: 'https://gw2rp-tools.ovh/api/events/' + eventId,
        dataType: 'json',
        success: function(json) {
          if (json.success) {
            var event = json.event;
            $('#event-details-modal-title').text(event.name);
            $('#event-details-modal-description').html(formatText(event.description));
            var date = new Date(event.end_date);
            if (date) {
              var dateString = date.toLocaleDateString().substr(0, 10);
              if (date.getHours() > 0) {
                dateString += " - " + date.toLocaleTimeString().substr(0, 5);
              }
              $('#event-details-modal-date').text(dateString);
            }
            $('#event-details-modal-difficulty').text(difficulty_table.get(event.difficulty));
            $('#event-details-modal-contact').text(event.contact);
            $('#event-details-modal-site').html("<a href='" + event.site + "' target='_blank'>" + event.site + "</a>");
            $('#event-details-modal #tomap-btn').attr('href', '/cartographe?id=' + event._id);
            $('#event-details-modal').modal('show');
          }
        }
      });
    }

    function addEventToList(idList, event) {
      var currentHtml = $(idList).html();
      var date = new Date(event.end_date);
      var dateString = date.toLocaleDateString().substr(0, 10);
      if (date.getHours() > 0) {
        dateString += " - " + date.toLocaleTimeString().substr(0, 5);
      }
      var thisEventHtml = '<div href="#" class="list-group-item flex-column align-items-start"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">' + event.name + '</h5><small>' + dateString + '</small></div><p class="mb-1" style="white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; max-height: 100px;">' + formatText(event.description) + '</p><a href="#" onclick="showEventModal(\'' +  event._id + '\')"><small>En lire plus...</small></a> ou <a href="/cartographe?id=' + event._id + '"><small>Voir sur la carte.</small></a></div>';
      currentHtml += thisEventHtml;
      $(idList).html(currentHtml);
    }

    function showRumourModal(rumourId) {
      $.ajax({
        method: "GET",
        url: 'https://gw2rp-tools.ovh/api/rumours/' + rumourId,
        dataType: 'json',
        success: function(json) {
          if (json.success) {
            var rumour = json.rumour;
            $('#rumour-details-modal-title').text(rumour.name);
            $('#rumour-details-modal-description').html(formatText(rumour.text));

            $('#rumour-details-modal-contact').text(rumour.contact);
            $('#rumour-details-modal-site').html("<a href='" + rumour.site + "' target='_blank'>" + rumour.site + "</a>");
            $('#rumour-details-modal #tomap-btn').attr('href', '/cartographe?id=' + rumour._id);
            $('#rumour-details-modal').modal('show');
          }
        }
      });
    }

    function addRumourToList(idList, rumour) {
      var currentHtml = $(idList).html();
      var thisRumourHtml = '<div href="#" class="list-group-item flex-column align-items-start"><div class="d-flex w-100 justify-content-between"><h5 class="mb-1">' + rumour.name + '</h5></div><p class="mb-1" style="white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; max-height: 100px;">' + formatText(rumour.text) + '</p><a href="#" onclick="showRumourModal(\'' +  rumour._id + '\')"><small>En lire plus...</small></a> ou <a href="/cartographe?id=' + rumour._id + '"><small>Voir sur la carte.</small></a></div>';
      currentHtml += thisRumourHtml;
      $(idList).html(currentHtml);
    }
  </script>

</body>
</html>
