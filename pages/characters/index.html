<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="theme-color" content="#000000">
  <meta name="description" content="">
  <meta name="author" content="Kavin 'Nakasar' Thizy">

  <title>Personnages - Outils RP</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
  <link rel="stylesheet" href="/components/style_global.css">
  <link rel="stylesheet" href="/src/open-iconic/font/css/open-iconic-bootstrap.css">
  <link rel="stylesheet" href="characters.css">

</head>
<body>
  <header>
    <div id="navigation">
    </div>
  </header>

  <!-- Modals -->
  <div>
    <!-- Deletion Confirmation Dialog -->
    <div id="modal-delete" class="modal fade" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Supprimer</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="message">Supprimer le personnage ?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onClick="confirmDelete()">Supprimer</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="container">
      <div class="alert alert-danger alert-dismissible" role="alert" id="main-alert" style="display: none;">
        <div id="text">Nous avons détecté une erreur inconnue. Le problème vient probablement de notre côté des Brumes :/</div>
        <button type="button" class="close" data-dismiss="alert" aria-label="Fermer">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    </div>
    <div class="row">

      <div class="container col-lg-4" id="characters-list">
        <form id="form-character" style="display: none;">
          <div class="form-group">
            <label for="name-form">Création d'un personnage</label>
            <div class="input-group">
              <input class="form-control" id="name-form" type="text" placeholder="Nom du personnage"/>
              <span class="input-group-btn">
                <button id="action-validate-character" type="button" class="btn btn-success float-right" onClick="validateCharacter()">Créer</button>
                <button id="action-cancel-character" type="button" class="btn btn-secondary float-right" onClick="cancelCharacter()">Annuler</button>
              </span>
            </div>
          </div>
        </form>
        <div class="row" id="character-list-head">
          <div class="col-md-8">
            <form id="form-search-character">
              <div class="input-group">
                <input id="search-character-text" type="text" class="form-control" placeholder="Chercher un personnage..." aria-label="Rercherche de personnage...">
                <span class="input-group-btn">
                  <button class="btn btn-secondary" type="button" onClick="searchCharacters()"><img src="/src/open-iconic/svg/magnifying-glass.svg" width="20px" heigth="20px" /></button>
                  <button class="btn btn-secondary" type="button" onClick="loadAll()"><img src="/src/open-iconic/svg/x.svg" width="20px" heigth="20px" /></button>
                </span>
              </div>
            </form>
          </div>
          <div class="col-md-4">
            <button id="action-create-character" style="display: none;" type="button" class="btn btn-success float-right" onClick="createCharacter()" title="Créer un personnage"><img src="/src/open-iconic/svg/plus.svg" width="30px" heigth="30px" /></button>
            <button id="action-my-characters" style="display: none;" type="button" class="btn btn-outline-info float-right" onClick="seeMyCharacters()" title="Mes personnages"><img src="/src/open-iconic/svg/people.svg" width="30px" heigth="30px" /n></button>
          </div>
        </div>

        <table class="table" id="characters-table">
          <thead class="thead-light">
            <tr>
              <th scope="col">Nom</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>

      <div class="container col-lg-8" id="character-detail">
        <div class="alert alert-warning alert-dismissible" role="alert" id="character-alert" style="display: none;">
          <div id="text">Il n'existe pas de personnage avec cet identifiant.</div>
          <button type="button" class="close" data-dismiss="alert" aria-label="Fermer">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <button type="button" class="action-return btn btn-secondary float-right" onClick="returnToList(false)">Retour à la liste</button>

        <h1>
          <span id="character-name">Personnage</span>
          <img src="/src/open-iconic/svg/pencil.svg" width="20px" heigth="20px" id="name-modify-button" onClick="modify('name')" class="action-button" title="éditer" aria-hidden="true" style="display: none; font-size: 1rem;" />
          <form id="character-name-form" style="display: none">
            <div class="form-group">
              <input type="text" class="form-control" id="name-textarea"/>
              <img src="/src/open-iconic/svg/check.svg" width="20px" heigth="20px" id="name-modify" onClick="save('name')" class="action-button" title="éditer" aria-hidden="true" style="font-size: 1rem;"/>
              <img src="/src/open-iconic/svg/x.svg" width="20px" heigth="20px" id="name-cancel" onClick="modify('')" class="action-button" title="annuler" aria-hidden="true" style="font-size: 1rem;" />
            </div>
          </form>
        </h1>

        <h2>Description</h2>
        <a id="description-modify" style="display:none" href="#" onclick="modify('description')">Modifier</a>
        <form id="description-form" style="display:none">
          <div class="btn-group" role="group" aria-label="Actions">
            <button type="button" class="btn btn-secondary" onClick="modify('')" id="cancel-button">Annuler</button>
            <button type="button" class="btn btn-success" onClick="save('description')" id="save-button">Enregistrer</button>
          </div>
          <div class="form-group">
            <textarea style="white-space: pre-wrap;" class="form-control" id="description-textarea" rows="5"></textarea>
          </div>
        </form>
        <p style="white-space: pre-wrap;" id="description"></p>

        <h2>Apparence</h2>
        <a id="appearance-modify" style="display:none" href="#" onclick="modify('appearance')">Modifier</a>
        <form id="appearance-form" style="display:none">
          <div class="btn-group" role="group" aria-label="Actions">
            <button type="button" class="btn btn-secondary" onClick="modify('')" id="cancel-button">Annuler</button>
            <button type="button" class="btn btn-success" onClick="save('appearance')" id="save-button">Enregistrer</button>
          </div>
          <div class="form-group">
            <textarea style="white-space: pre-wrap;" class="form-control" id="appearance-textarea" rows="5"></textarea>
          </div>
        </form>
        <p style="white-space: pre-wrap;" id="appearance"></p>

        <h2>Caractéristiques</h2>
        <table class="table" id="caracteristics-table">
          <thead class="thead-light">
            <tr>
              <th scope="col">Caractéristique</th>
              <th scope="col">Valeur</th>
              <th scope="col">Remarques</th>
              <th scope="col" style="display: none;" class="table-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
          <tfoot style="display: none;">
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td><button type="button" class="btn btn-success float-right" onClick="createEntry('caract')">+</button></td>
            </tr>
          </tfoot>
        </table>

        <h2>Compétences</h2>
        <table class="table" id="skills-table">
          <thead class="thead-light">
            <tr>
              <th scope="col">Compétence</th>
              <th scope="col">Valeur</th>
              <th scope="col">Remarques</th>
              <th scope="col" style="display: none;" class="table-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
          <tfoot style="display: none;">
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td><button type="button" class="btn btn-success float-right" onClick="createEntry('skill')">+</button></td>
            </tr>
          </tfoot>
        </table>

        <div id="actions">
          <button type="button" class="btn btn-success" onClick="actionSave()" id="action-save" style="display: none;">Enregistrer</button>
          <button type="button" class="btn btn-warning" onClick="actionRevert()" id="action-revert" style="display: none;">Annuler</button>
          <button type="button" class="btn btn-danger" onClick="actionDelete()" id="action-delete">Supprimer</button>
        </div>

        <hr/>

        <button type="button" style="margin-left: auto; margin-right: 0;" class="action-return btn btn-secondary" onClick="returnToList(false)">Retour à la liste</button>
      </div>
    </div>
  </div>

  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

  <script src="/components/base.js"></script>
  <script src="/components/connect.js"></script>

  <script>
  $('#characters-list').hide();
  $('#character-detail').hide();
  $('#character-alert').hide();

  $('#navigation').load("/components/header.html", function() {
    $('#nav-characters').addClass('active');
    establishConnectionCallback(function(success) {
      // Display specific character if in url, full list otherwise.
      // Search for URL parameters (location, coord...)
      var url = new URL(window.location.href);
      if (url.searchParams.has("id")) {
        // Url has a given ID, search for the matching location and zoom to it.
        var id = url.searchParams.get("id");
        loadCharacter(id);
        if (deviceCategory() === "lg") {
          loadAll()
        } else {
          $('.action-return').attr('onClick', 'returnToList(true)');
        }
      } else {
        loadAll();
      }
    });
  });

  function displayAPIAlert() {
    $('#main-alert #text').text("Le GOLEM M4554G3R n'a pas pu contacter le serveur dans les Brumes, le problème vient certainement de notre côté.");
    $('#main-alert').show();
  }

  function resizeHandler(category) {
    if (category === "lg") {
      // Go to master/detail
      if (!loadedAll) {
        loadAll();
      }
      $('#characters-list').show();
      if (thisCharacter) {
        $('#character-detail').css("visibility", "visible");
      }
      $('#character-detail').show();
    } else {
      // Display only master or detail
      if (thisCharacter) {
        $('#character-detail').css("visibility", "visible");
        $('#character-detail').show();
        $('#characters-list').hide();
      } else {
        $('#character-detail').css("visibility", "visible");
        $('#character-detail').hide();
        $('#characters-list').show();
      }
    }
  }
  </script>

  <script>
  class Character {
    constructor(id, owner, name, description, appearance) {
      this.id = id;
      this.owner = owner;
      this.name = name;
      this.description = description;
      this.appearance = appearance;
      this.caracteristics = new Map();
      this.skills = new Map();
      this.entryCount = 1;
    }

    static parse(json) {
      var j_id = json._id, j_owner = json.owner, j_name = json.name, j_description = "", j_appearance = "";
      if (json.description) {
        j_description = json.description.replace(regex_html, "");
      }
      if (json.appearance) {
        j_appearance = json.appearance.replace(regex_html, "");
      }

      var character = new Character(j_id, j_owner, j_name, j_description, j_appearance);

      if (json.caracteristics) {
        for(var i in json.caracteristics) {
          character.addCaracteristic(json.caracteristics[i]);
        }
      }
      if (json.skills) {
        for(var i in json.skills) {
          character.addSkill(json.skills[i]);
        }
      }
      return character;
    }

    addCaracteristic(caracteristic) {
      if (caracteristic._id) {
        this.caracteristics.set(caracteristic._id, caracteristic);
      } else {
        this.caracteristics.set(this.nextId(), caracteristic);
      }
    }

    removeCaracteristic(id) {
      if (this.caracteristics.has(id)) {
        this.caracteristics.delete(id);
      }
    }

    addSkill(skill) {
      if (skill._id) {
        this.skills.set(skill._id, skill);
      } else {
        this.skills.set(this.nextId(), skill);
      }
    }

    removeSkill(id) {
      if (this.skills.has(id)) {
        this.skills.delete(id);
      }
    }

    modifyEntry(field, id, entry) {
      switch (field) {
        case "caract":
          this.caracteristics.set(id, entry);
          break;
        case "skill":
          this.skills.set(id, entry);
          break;
        default:
          break;
      }
    }

    // Will save this character to the API.
    save() {
      var name = this.name.replace(regex_html, ""),
        description = this.description.replace(regex_html, ""),
        appearance = this.appearance.replace(regex_html, ""),
        image_url = "",
        caracteristics = [],
        skills = [];

      for (var [id, caract] of this.caracteristics) {
        caracteristics.push({ name: caract.name, value: caract.value, remark: caract.remark });
      }

      for (var [id, skill] of this.skills) {
        skills.push({ name: skill.name, value: skill.value, remark: skill.remark });
      }

      $.ajax({
        method: "PUT",
        url: 'https://gw2rp-tools.ovh/api/characters/' + thisCharacter.id,
        data: { token: thisUser.token, name: name, description: description, appearance: appearance, image_url: image_url, caracteristics: caracteristics, skills: skills },
        dataType: 'json',
        success: function(json) {
          console.log(json);
          if (json.success) {
            loadCharacter(json.character._id);
            $('#actions > #action-save').removeClass("disabled");
            $('#actions > #action-revert').removeClass("disabled");
            $('#actions > #action-delete').removeClass("disabled");
          }
        },
        error: function(json) {
          displayAPIAlert();
          $('#actions > #action-save').removeClass("disabled");
          $('#actions > #action-revert').removeClass("disabled");
          $('#actions > #action-delete').removeClass("disabled");
        }
      });
    }

    nextId() {
      return this.entryCount++;
    }
  }

  var thisCharacter;
  var modified = false;
  var loadedAll = false;

  function stateToModified() {
    modified = true;
    $('#action-save').show();
    $('#action-revert').show();
  }

  function stateToSync() {
    modified = false;
    $('#action-save').hide();
    $('#action-revert').hide();
  }

  function loadCharacter(id) {
    $.ajax({
      method: "GET",
      url: 'https://gw2rp-tools.ovh/api/characters/' + id,
      dataType: 'json',
      success: function(json) {
        console.log(json);
        if (json.success) {
          parseCharacter(json.character);
          stateToSync();
        } else {
          $('#character-alert').show();
          loadAll();
        }
      },
      error: function(json) {
        displayAPIAlert();
      }
    });
  }

  // All, search, mines
  var mode = "all";
  function setListMode(newState) {
      $('#action-create-character').show();
    if (signedIn) {
      $('#action-my-characters').show();
    } else {
      $('#action-my-characters').hide();
    }

    $('#action-my-characters').removeClass('btn-info').addClass('btn-outline-info').attr("title", "Mes personnages");;
    switch (newState) {
      case "mines":
        $('#action-my-characters').removeClass('btn-outline-info').addClass('btn-info').attr("title", "Tous les personnages");
        mode = "mines";
        break;
      case "search":
        mode = "search";
        break;
      default: // "all"
        mode = "all";
        break;
    }
  }

  function loadAll() {
    $.ajax({
      method: "GET",
      url: 'https://gw2rp-tools.ovh/api/characters',
      dataType: 'json',
      success: function(json) {
        if (json.success) {
          parseCharactersToTable(json.characters);
          setListMode("all");
          loadedAll = true;
          $('#search-character-text').val("");
        }
      },
      error: function(json) {
        displayAPIAlert();
      }
    });
  }

  function seeMyCharacters() {
    if (mode == "mines") {
      loadAll();
    } else {
      if (signedIn && thisUser.id) {
        $.ajax({
          method: "GET",
          url: 'https://gw2rp-tools.ovh/api/users/' + thisUser.id + '/characters',
          dataType: 'json',
          success: function(json) {
            if (json.success) {
              parseCharactersToTable(json.characters);
              setListMode("mines");
            }
          },
          error: function(json) {
            displayAPIAlert();
          }
        });
      }
    }
  }

  const character_name_regex = /^[a-zA-Z \-_'\u00C0-\u017F]{0,40}$/;
  function searchCharacters() {
    var search = $('#search-character-text').val();
    if (character_name_regex.test(search)) {
      $.ajax({
        method: "GET",
        url: 'https://gw2rp-tools.ovh/api/characters?search=' + search,
        dataType: 'json',
        success: function(json) {
          if (json.success) {
            parseCharactersToTable(json.characters);
            setListMode("search");
          }
        },
        error: function(json) {
          displayAPIAlert();
        }
      });
    } else {
      console.log("Invalid search params")
    }
  }

  function emptyCharacterDetail() {
    $('#character-detail #character-name').text("Personnage");
    $('#character-detail > #description').html("");
    $('#character-detail > #appearance').html("");
    $('#character-detail #caracteristics-table > tbody > tr').remove();
    $('#character-detail #skills-table > tbody > tr').remove();
  }

  function parseCharacter(character) {
    thisCharacter = Character.parse(character);
    if (thisCharacter) {
      if (deviceCategory() !== "lg") {
        $('#characters-list').hide();
      } else {
        $('#characters-list').show();
      }

      $('#character-detail #character-name').text(character.name);
      if (character.description) {
        $('#character-detail > #description').html(formatText(character.description));
      } else {
        $('#character-detail > #description').html("");
      }
      if (character.appearance) {
        $('#character-detail > #appearance').html(formatText(character.appearance));
      } else {
        $('#character-detail > #appearance').html("");
      }

      $('#character-detail #caracteristics-table > tbody > tr').remove();
      if (character.caracteristics) {
        for (var i in character.caracteristics) {
          var caract = character.caracteristics[i];
          var caractHtml = '<tr id="' + caract._id + '">';
          caractHtml += '<td id="name">' + caract.name + '</td>';
          caractHtml += '<td id="value">' + caract.value + '</td>';
          caractHtml += '<td id="remark">' + caract.remark + '</td>';
          caractHtml += '<td class="table-actions" id="actions"><div id="actions-default"><img src="/src/open-iconic/svg/pencil.svg" width="20px" heigth="20px" onClick="modifyEntry(\'caract\', \'' + caract._id + '\')" class="action-button" title="éditer" aria-hidden="true" /> <img src="/src/open-iconic/svg/delete.svg" width="20px" heigth="20px" onClick="deleteEntry(\'caract\', \'' + caract._id + '\')" class="action-button" title="supprimer" aria-hidden="true" /></div><div id="actions-edited" style="display: none;">' + `<img src="/src/open-iconic/svg/check.svg" width="20px" heigth="20px" onClick="saveEntry('caract', '` + caract._id  + `')" class="action-button" title="valider" aria-hidden="true" /> ` + `<img src="/src/open-iconic/svg/x.svg" width="20px" heigth="20px" onClick="modifyEntry('', '` + caract._id  + `')" class="action-button" title="annuler" aria-hidden="true" />` + '</div></td>';
          caractHtml += '</tr>';
          $('#character-detail #caracteristics-table > tbody').append(caractHtml);
        }
      }

      $('#character-detail #skills-table > tbody > tr').remove();
      if (character.skills) {
        for (var i in character.skills) {
          var skill = character.skills[i];
          var skillHtml = '<tr id="' + skill._id + '">';
          skillHtml += '<td id="name">' + skill.name + '</td>';
          skillHtml += '<td id="value">' + skill.value + '</td>';
          skillHtml += '<td id="remark">' + skill.remark + '</td>';
          skillHtml += '<td class="table-actions" id="actions"><div id="actions-default"><img src="/src/open-iconic/svg/pencil.svg" width="20px" heigth="20px" onClick="modifyEntry(\'skill\', \'' + skill._id + '\')" class="action-button" title="éditer" aria-hidden="true" /> <img src="/src/open-iconic/svg/delete.svg" width="20px" heigth="20px" onClick="deleteEntry(\'skill\', \'' + skill._id + '\')" class="action-button" title="supprimer" aria-hidden="true" /></div><div id="actions-edited" style="display: none;">' + `<img src="/src/open-iconic/svg/check.svg" width="20px" heigth="20px" onClick="saveEntry('skill', '` + skill._id  + `')" class="action-button" title="valider" aria-hidden="true" /> ` + `<img src="/src/open-iconic/svg/x.svg" width="20px" heigth="20px" onClick="modifyEntry('', '` + skill._id  + `')" class="action-button" title="annuler" aria-hidden="true" />` + '</div></td>';
          skillHtml += '</tr>';
          $('#character-detail #skills-table > tbody').append(skillHtml);
        }
      }

      if (signedIn && (thisUser.admin || thisUser.id === thisCharacter.owner)) {
        $('#action-delete').show();
        $('#name-modify-button').show();
        $('#character-detail #description-modify').show();
        $('#character-detail #appearance-modify').show();
        $('#character-detail #caracteristics-table > tfoot').show();
        $('#character-detail #skills-table > tfoot').show();
        $('#character-detail .table-actions').show();
      } else {
        $('#action-delete').hide();
        $('#name-modify-button').hide()
        $('#character-detail #description-modify').hide();
        $('#character-detail #appearance-modify').hide();
        $('#character-detail #caracteristics-table > tfoot').hide();
        $('#character-detail #skills-table > tfoot').hide();
        $('#character-detail .table-actions').hide();
      }

      $('#character-detail').show();
      $('#character-detail').css("visibility", "visible");
      var stateObj = { foo: "bar" };
      history.pushState(stateObj, character.name, "?id=" + character._id);
    } else {
      loadAll();
    }
  }

  function parseCharactersToTable(characters) {
    $('#characters-table > tbody > tr').remove();
    $('#characters-list').show();
    if (deviceCategory() !== "lg") {
      $('#character-detail').hide();
    } else {
      if (!thisCharacter) {
        $('#character-detail').css("visibility", "hidden");
      }
      $('#character-detail').show()
    }
    for (var i in characters) {
      var character = characters[i];
      var characterHtml = '<tr id="' + character._id + '">';
      characterHtml += '<th scope="row" id="character-row-name">' + character.name + '</th>';
      characterHtml += '<td><div class="btn-group" role="group" aria-label="Actions">';
      characterHtml += '<button type="button" class="btn btn-primary" onClick="viewCharacter(\'' + character._id + '\')">Voir</button>'; // Detail action
      characterHtml += '</td>';
      characterHtml += '</tr>';
      $('#characters-table > tbody').append(characterHtml);
    }
  }

  function viewCharacter(id) {
    loadCharacter(id);
  }

  function returnToList(requireReload) {
    thisCharacter = {};
    var stateObj = { foo: "bar" };
    history.pushState(stateObj, "Liste des personnages", ".");
    emptyCharacterDetail();
    if (deviceCategory() !== "lg") {
      $('#character-detail').hide();
    } else {
      $('#character-detail').css("visibility", "hidden");
      $('#character-detail').show();
    }
    if (requireReload) {
      loadAll();
    } else {
      $('#characters-list').show();
    }
  }

  function actionModify() {

  }

  function actionDelete() {
    $("#modal-delete #message").text("Supprimer " + thisCharacter.name + " ?");
    $("#modal-delete").modal('show');
  }

  function actionSave() {
    console.log("Saving character...");
    $('#actions > #action-save').addClass('disabled');
    $('#actions > #action-delete').addClass('disabled');
    $('#actions > #action-revert').addClass('disabled');
    thisCharacter.save();
  }

  function actionRevert() {
    console.log("Reverting character...");
    loadCharacter(thisCharacter.id);
  }

  function confirmDelete() {
    $.ajax({
      method: "DELETE",
      url: 'https://gw2rp-tools.ovh/api/characters/' + thisCharacter.id,
      data: { token: thisUser.token },
      dataType: 'json',
      success: function(json) {
        if (json.success) {
          $("#modal-delete").modal('hide');
          returnToList(true);
        } else {
          console.log(json);
        }
      },
      error: function(json) {
        displayAPIAlert();
      }
    });
  }

  function modify(field) {
    $('#character-name').show();
    $('#name-modify-button').show();
    $('#description-modify').show();
    $('#appearance-modify').show();
    $('#character-name-form').hide();
    $('#description-form').hide();
    $('#appearance-form').hide();
    switch (field) {
      case "name":
        $('#character-name').hide();
        $('#name-modify-button').hide();
        $('#name-textarea').val(thisCharacter.name);
        $('#character-name-form').show();
        break;
      case "description":
        $('#description-modify').hide();
        $('#description-textarea').val(thisCharacter.description);
        $('#description-form').show();
        break;
      case "appearance":
        $('#appearance-modify').hide();
        $('#appearance-textarea').val(thisCharacter.appearance);
        $('#appearance-form').show();
        break;
      default:
        break;
    }
  }

  function resetEntry(field, id) {
    console.log("Quit edit mode for entry " + field + ", id: " + id);
  }

  var tmpField = {};
  function modifyEntry(field, id) {
    console.log("Enter edit mode for entry " + field + ", id: " + id);
    if (!id) {
      return;
    }

    var thisLine = $('#' + id);
    if (tmpField._id) {
      var oldLine = $('#' + tmpField._id);
      // Remove old line if empty.
      if (tmpField.name.length > 0) {
        oldLine.find('#name').text(tmpField.name);
        oldLine.find('#value').text(tmpField.value);
        oldLine.find('#remark').text(tmpField.remark);
        oldLine.find('#actions > #actions-default').show();
        oldLine.find('#actions > #actions-edited').hide();
      } else {
        // Remove entry from UI
        oldLine.remove();
        if (thisCharacter.caracteristics.has(tmpField._id)) {
          thisCharacter.removeCaracteristic(tmpField._id);
        } else if (thisCharacter.skills.has(tmpField._id)) {
          thisCharacter.removeSkill(tmpField._id);
        }
      }
    }

    switch (field) {
      case "caract":
        tmpField = { _id: id, name: thisLine.find('#name').text(), value: thisLine.find('#value').text(), remark: thisLine.find('#remark').text() };
        var nameFormHtml = '<form><div class="form-group"><input class="form-control" type="text" id="name-form" value="' + thisLine.find('#name').text() + '"/></div></form>'
        thisLine.find('#name').html(nameFormHtml);
        var valueFormHtml = '<form><div class="form-group"><input class="form-control" type="number" id="value-form" value="' + thisLine.find('#value').text() + '"/></div></form>'
        thisLine.find('#value').html(valueFormHtml);
        var remarkFormHtml = '<form><div class="form-group"><input class="form-control" type="text" id="remark-form" value="' + thisLine.find('#remark').text() + '"/></div></form>'
        thisLine.find('#remark').html(remarkFormHtml);
        thisLine.find('#actions > #actions-default').hide();
        thisLine.find('#actions > #actions-edited').show();
        break;
      case "skill":
        tmpField = { _id: id, name: thisLine.find('#name').text(), value: thisLine.find('#value').text(), remark: thisLine.find('#remark').text() };
        var nameFormHtml = '<form><div class="form-group"><input class="form-control" type="text" id="name-form" value="' + thisLine.find('#name').text() + '"/></div></form>'
        thisLine.find('#name').html(nameFormHtml);
        var valueFormHtml = '<form><div class="form-group"><input class="form-control" type="number" id="value-form" value="' + thisLine.find('#value').text() + '"/></div></form>'
        thisLine.find('#value').html(valueFormHtml);
        var remarkFormHtml = '<form><div class="form-group"><input class="form-control" type="text" id="remark-form" value="' + thisLine.find('#remark').text() + '"/></div></form>'
        thisLine.find('#remark').html(remarkFormHtml);
        thisLine.find('#actions > #actions-default').hide();
        thisLine.find('#actions > #actions-edited').show();
        break;
      default:
        tmpField = {};
        break;
    }
  }

  function saveEntry(field, id) {
    console.log("Save entry " + field + ", id: " + id);
    if (!id || !field) {
      return;
    }
    var thisLine = $('#' + id);
    if (thisLine) {
      tmpField = { _id: id, name: thisLine.find('#name-form').val().replace(regex_html, ""), value: thisLine.find('#value-form').val().replace(regex_html, ""), remark: thisLine.find('#remark-form').val().replace(regex_html, "") };
      thisCharacter.modifyEntry(field, id, tmpField);
      modifyEntry("", id);
      stateToModified();
    }
  }

  function deleteEntry(field, id) {
    console.log("Delete entry " + field + ", id: " + id);
    if (!id || !field) {
      return;
    }
    switch (field) {
      case "caract":
        thisCharacter.removeCaracteristic(id);
        var thisLine = $('#' + id).remove();
        stateToModified();
        break;
      case "skill":
        thisCharacter.removeSkill(id);
        var thisLine = $('#' + id).remove();
        stateToModified();
        break;
      default:
        break;
    }
  }

  function createEntry(field) {
    console.log("Create new entry " + field);
    var id = thisCharacter.nextId();
    switch (field) {
      case "caract":
        var caractHtml = '<tr id="' + id + '">';
        caractHtml += '<td id="name">' + '</td>';
        caractHtml += '<td id="value">' + '</td>';
        caractHtml += '<td id="remark">' +'</td>';
        caractHtml += '<td class="table-actions" id="actions"><div id="actions-default"><img src="/src/open-iconic/svg/pencil.svg" width="20px" heigth="20px" onClick="modifyEntry(\'caract\', \'' + id + '\')" class="action-button" title="éditer" aria-hidden="true"></img> <img src="/src/open-iconic/svg/delete.svg" width="20px" heigth="20px" onClick="deleteEntry(\'caract\', \'' + id + '\')" class="action-button" title="supprimer" aria-hidden="true"></img></div><div id="actions-edited" style="display: none;">' + `<img src="/src/open-iconic/svg/check.svg" width="20px" heigth="20px" onClick="saveEntry('caract', '` + id  + `')" class="action-button" title="valider" aria-hidden="true"></img> ` + `<img src="/src/open-iconic/svg/x.svg" width="20px" heigth="20px" onClick="modifyEntry('', '` + id  + `')" class="action-button" title="annuler" aria-hidden="true"></img>` + '</div></td>';
        caractHtml += '</tr>';
        $('#character-detail #caracteristics-table > tbody').append(caractHtml);
        modifyEntry("caract", id);
        break;
      case "skill":
        var skillHtml = '<tr id="' + id + '">';
        skillHtml += '<td id="name">' + '</td>';
        skillHtml += '<td id="value">'+ '</td>';
        skillHtml += '<td id="remark">' + '</td>';
        skillHtml += '<td class="table-actions" id="actions"><div id="actions-default"><img src="/src/open-iconic/svg/pencil.svg" width="20px" heigth="20px" onClick="modifyEntry(\'skill\', \'' + id + '\')" class="action-button" title="éditer" aria-hidden="true"></img> <img src="/src/open-iconic/svg/delete.svg" width="20px" heigth="20px onClick="deleteEntry(\'skill\', \'' + id + '\')" class="action-button" title="supprimer" aria-hidden="true"></img></div><div id="actions-edited" style="display: none;">' + `<img src="/src/open-iconic/svg/check.svg" width="20px" heigth="20px" onClick="saveEntry('skill', '` + id  + `')" class="action-button" title="valider" aria-hidden="true"></img> ` + `<img src="/src/open-iconic/svg/x.svg" width="20px" heigth="20px" onClick="modifyEntry('', '` + id  + `')" class="action-button" title="annuler" aria-hidden="true"></img>` + '</div></td>';
        skillHtml += '</tr>';
        $('#character-detail #skills-table > tbody').append(skillHtml);
        modifyEntry("skill", id);
        break;
      default:
        break;
    }
  }

  function save(field) {
    switch (field) {
      case "name":
        $('#name-form #save-button').addClass("disabled");
        $('#name-form #cancel-button').addClass("disabled");
        var name = $('#name-textarea').val().replace(regex_html, "");
        $.ajax({
          method: "PUT",
          url: 'https://gw2rp-tools.ovh/api/characters/' + thisCharacter.id,
          data: { token: thisUser.token, name: name },
          dataType: 'json',
          success: function(json) {
            console.log(json);
            if (json.success) {
              $("#character-detail #character-name").text(json.character.name);
              thisCharacter.name = json.character.name;
              $('#' + thisCharacter.id + ' #character-row-name').text(thisCharacter.name);
              modify("");
            }
            $('#name-form #save-button').removeClass("disabled");
            $('#name-form #cancel-button').removeClass("disabled");
          },
          error: function(json) {
            displayAPIAlert();
            $('#name-form #save-button').removeClass("disabled");
            $('#name-form #cancel-button').removeClass("disabled");
          }
        });
        break;
      case "description":
        $('#description-form #save-button').addClass("disabled");
        $('#description-form #cancel-button').addClass("disabled");
        var description = $('#description-textarea').val().replace(regex_html, "");
        $.ajax({
          method: "PUT",
          url: 'https://gw2rp-tools.ovh/api/characters/' + thisCharacter.id,
          data: { token: thisUser.token, description: description },
          dataType: 'json',
          success: function(json) {
            console.log(json);
            if (json.success) {
              $("#character-detail #description").html(formatText(json.character.description));
              thisCharacter.description = json.character.description;
              modify("");
            }
            $('#description-form #save-button').removeClass("disabled");
            $('#description-form #cancel-button').removeClass("disabled");
          },
          error: function(json) {
            displayAPIAlert();
            $('#description-form #save-button').removeClass("disabled");
            $('#description-form #cancel-button').removeClass("disabled");
          }
        });
        break;
      case "appearance":
        $('#appearance-form #save-button').addClass("disabled");
        $('#appearance-form #cancel-button').addClass("disabled");
        var appearance = $('#appearance-textarea').val().replace(regex_html, "");
        $.ajax({
          method: "PUT",
          url: 'https://gw2rp-tools.ovh/api/characters/' + thisCharacter.id,
          data: { token: thisUser.token, appearance: appearance },
          dataType: 'json',
          success: function(json) {
            console.log(json);
            if (json.success) {
              $("#character-detail #appearance").html(formatText(json.character.appearance));
              thisCharacter.appearance = json.character.appearance;
              modify("");
            }
            $('#appearance-form #save-button').removeClass("disabled");
            $('#appearance-form #cancel-button').removeClass("disabled");
          },
          error: function(json) {
            displayAPIAlert();
            $('#appearance-form #save-button').removeClass("disabled");
            $('#appearance-form #cancel-button').removeClass("disabled");
          }
        });
        break;
      default:
        break;
    }
    return true;
  }



  function createCharacter() {
    if (signedIn) {
      $("#form-character").show();
      $("#action-create-character").hide();
    } else {
      showLoginModal();
    }
  }

  function validateCharacter() {
    $("#form-character #name-form").attr("disabled", true);
    $("#form-character #action-validate-character").attr("disabled", true);
    $("#form-character #action-cancel-character").attr("disabled", true);

    var name = $("#form-character #name-form").val().replace(regex_html, "");

    const defaultCaracteristics = [
      { name: "Charisme", value: 15, remark: ""},
      { name: "Constitution", value: 15, remark: ""},
      { name: "Dextérité", value: 15, remark: ""},
      { name: "Force", value: 15, remark: ""},
      { name: "Intelligence", value: 15, remark: ""},
      { name: "Sagesse", value: 15, remark: ""},
      { name: "Volonté", value: 15, remark: ""}
    ];
    const defaultSkills = [
      { name: "Acuité visuelle", value: 10, remark: ""},
      { name: "Acuité sonore", value: 10, remark: ""},
      { name: "Acuité olphactive", value: 10, remark: ""},
      { name: "Acuité étherique", value: 10, remark: ""},
      { name: "Pugilat", value: 10, remark: ""},
      { name: "Réactivité", value: 10, remark: ""},
      { name: "Esquive", value: 10, remark: ""},
      { name: "Vitalité", value: 10, remark: ""},
      { name: "Endurance", value: 10, remark: ""},
      { name: "Survie", value: 10, remark: ""},
      { name: "Mémorisation", value: 10, remark: ""},
      { name: "Education", value: 10, remark: ""}
    ];

    $.ajax({
      method: "POST",
      url: 'https://gw2rp-tools.ovh/api/characters/',
      data: { token: thisUser.token, name: name, caracteristics: defaultCaracteristics, skills: defaultSkills, status: "played" },
      dataType: 'json',
      success: function(json) {
        console.log(json);
        if (json.success) {
          loadCharacter(json.character._id);
          $("#form-character #name-form").val("");
          $("#form-character #name-form").attr("disabled", false);
          $("#form-character #action-validate-character").attr("disabled", false);
          $("#form-character #action-cancel-character").attr("disabled", false);
          $("#form-character").hide();
          $("#action-create-character").show();
          $('.action-return').attr('onClick', 'returnToList(true)');
        }
      },
      error: function(json) {
        displayAPIAlert();
        $("#form-character #name-form").attr("disabled", false);
        $("#form-character #action-validate-character").attr("disabled", false);
        $("#form-character #action-cancel-character").attr("disabled", false);
      }
    });
  }

  function cancelCharacter() {
    $("#form-character").hide();
    $("#action-create-character").show();
  }
  </script>

</body>
</html>
